<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Horizon | AI Research Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Gemini SDK -->
    <script type="importmap">
    {
        "imports": {
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
    }
    </script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        window.GoogleGenerativeAI = GoogleGenerativeAI;
    </script>
    
    <style>
        body {
            background-color: #0f172a;
            background-image: linear-gradient(to bottom, #1e293b 0%, #0f172a 100%);
            color: #f1f5f9;
            font-family: 'Inter', system-ui, sans-serif;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.3);
            border-radius: 10px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(139, 92, 246, 0.5);
        }

        /* Message animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-enter {
            animation: slideIn 0.3s ease-out;
        }

        /* Typing indicator */
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        .typing-dot {
            animation: pulse 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
    </style>
</head>

<body class="flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <header class="px-6 py-4 border-b border-slate-700 bg-slate-900/50 backdrop-blur-xl">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="dashboard.html" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5 text-slate-400"></i>
                </a>
                <div>
                    <p class="text-purple-400 text-xs font-semibold uppercase tracking-wider">AI Research Lab</p>
                    <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                        <i data-lucide="sparkles" class="w-6 h-6 text-purple-500"></i>
                        Gemini Research Assistant
                    </h1>
                </div>
            </div>
            
            <!-- Settings Toggle -->
            <button onclick="toggleSettings()" class="glass-card px-4 py-2 rounded-lg hover:bg-slate-700/50 transition-all flex items-center gap-2">
                <i data-lucide="settings" class="w-4 h-4 text-purple-400"></i>
                <span class="text-sm font-medium text-slate-300">Settings</span>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- Settings Sidebar (Hidden by default) -->
        <aside id="settings-sidebar" class="w-80 border-r border-slate-700 bg-slate-900/50 backdrop-blur-xl p-6 overflow-y-auto custom-scroll hidden">
            <div class="mb-6">
                <h3 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
                    <i data-lucide="sliders" class="w-4 h-4 text-purple-400"></i>
                    AI Configuration
                </h3>
                
                <!-- Model Selector -->
                <div class="mb-4">
                    <label class="text-[9px] text-slate-500 font-bold uppercase tracking-widest mb-1.5 block">Gemini Model</label>
                    <select id="gemini-model"
                        class="appearance-none w-full bg-black/20 text-xs text-white border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:border-purple-500/50 hover:bg-white/5 cursor-pointer font-medium">
                        <option value="gemini-3-flash-preview" selected style="background-color: #1e293b; color: white;">‚ö° Gemini 3 Flash Preview</option>
                        <option value="gemini-3-pro-preview" style="background-color: #1e293b; color: white;">‚ú® Gemini 3 Pro Preview</option>
                        <option value="gemini-2.0-flash-exp" style="background-color: #1e293b; color: white;">Gemini 2.0 Flash Exp</option>
                        <option value="gemini-1.5-flash" style="background-color: #1e293b; color: white;">Gemini 1.5 Flash</option>
                        <option value="gemini-1.5-pro" style="background-color: #1e293b; color: white;">Gemini 1.5 Pro</option>
                    </select>
                </div>
                
                <!-- Custom API Key -->
                <div class="mb-4">
                    <label class="text-[9px] text-slate-500 font-bold uppercase tracking-widest mb-1.5 block">Custom API Key (Optional)</label>
                    <div class="relative">
                        <input type="password" id="custom-api-key" placeholder="Enter your Gemini API key..."
                            class="w-full bg-black/20 text-xs text-white border border-white/10 rounded-xl px-3 py-2 pr-10 focus:outline-none focus:border-purple-500/50 hover:bg-white/5 font-mono placeholder:text-slate-600">
                        <button onclick="toggleApiKeyVisibility()" class="absolute right-2 top-1/2 -translate-y-1/2 p-1 hover:bg-white/10 rounded transition-colors">
                            <i data-lucide="eye" id="api-eye-icon" class="w-3.5 h-3.5 text-slate-500"></i>
                        </button>
                    </div>
                    <p class="text-[8px] text-slate-600 mt-1.5">Leave empty to use default. Get yours at <a href="https://aistudio.google.com/apikey" target="_blank" class="text-purple-400 hover:underline">AI Studio</a></p>
                </div>
            </div>

            <!-- Features Info -->
            <div class="mt-8 p-4 bg-purple-500/10 border border-purple-500/20 rounded-xl">
                <h4 class="text-xs font-bold text-purple-300 mb-2">Research Capabilities</h4>
                <ul class="space-y-1.5 text-[10px] text-slate-400">
                    <li class="flex items-center gap-2">
                        <span class="text-purple-400">‚Ä¢</span> Natural language research queries
                    </li>
                    <li class="flex items-center gap-2">
                        <span class="text-blue-400">‚Ä¢</span> Auto-generated charts & graphs
                    </li>
                    <li class="flex items-center gap-2">
                        <span class="text-emerald-400">‚Ä¢</span> NASA image search integration
                    </li>
                    <li class="flex items-center gap-2">
                        <span class="text-orange-400">‚Ä¢</span> Contextual follow-up questions
                    </li>
                </ul>
            </div>
        </aside>

        <!-- Chat Area -->
        <main class="flex-1 flex flex-col">
            
            <!-- Messages Container -->
            <div id="chat-messages" class="flex-1 overflow-y-auto custom-scroll p-6 space-y-4">
                
                <!-- Welcome Message -->
                <div class="flex gap-3 items-start message-enter">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center shrink-0 shadow-lg shadow-purple-500/30">
                        <i data-lucide="sparkles" class="w-5 h-5 text-white"></i>
                    </div>
                    <div class="flex-1 glass-card p-4 rounded-2xl rounded-tl-sm border-purple-500/20">
                        <p class="text-sm text-slate-300 mb-3">üëã Welcome to the Gemini Research Assistant! I can help you with:</p>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="bg-purple-500/10 p-2 rounded-lg">
                                <span class="text-purple-400 font-semibold">üìä</span> Data analysis & charts
                            </div>
                            <div class="bg-blue-500/10 p-2 rounded-lg">
                                <span class="text-blue-400 font-semibold">üî¨</span> Scientific research
                            </div>
                            <div class="bg-emerald-500/10 p-2 rounded-lg">
                                <span class="text-emerald-400 font-semibold">üñºÔ∏è</span> NASA image search
                            </div>
                            <div class="bg-orange-500/10 p-2 rounded-lg">
                                <span class="text-orange-400 font-semibold">üí°</span> Space & climate topics
                            </div>
                        </div>
                        <p class="text-[10px] text-slate-500 mt-3">Try asking: "Show me data about Mars missions" or "Find images of nebulas"</p>
                    </div>
                </div>

            </div>

            <!-- Input Area -->
            <div class="border-t border-slate-700 bg-slate-900/50 backdrop-blur-xl p-6">
                <div class="max-w-4xl mx-auto">
                    <div class="relative">
                        <textarea id="chat-input" placeholder="Ask me anything about space, climate, or scientific research..." rows="1"
                            class="w-full bg-slate-800/60 border border-slate-600 rounded-2xl py-4 pl-4 pr-32 text-sm text-white placeholder:text-slate-500 focus:outline-none focus:border-purple-500/60 focus:bg-slate-800/80 transition-all resize-none max-h-32"></textarea>
                        
                        <div class="absolute right-2 top-2 flex gap-2">
                            <button onclick="searchImages()" class="p-2.5 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 rounded-lg transition-all border border-blue-500/30" title="Search NASA Images">
                                <i data-lucide="image" class="w-4 h-4"></i>
                            </button>
                            <button onclick="sendMessage()" id="send-btn" class="px-4 py-2.5 bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white rounded-lg transition-all shadow-lg shadow-purple-500/30 flex items-center gap-2">
                                <span class="text-sm font-semibold">Send</span>
                                <i data-lucide="send" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-[10px] text-slate-500 mt-2 text-center">Press Enter to send ‚Ä¢ Shift+Enter for new line ‚Ä¢ Click üñºÔ∏è to search NASA images</p>
                </div>
            </div>

        </main>
    </div>

    <script>
        lucide.createIcons();

        const DEFAULT_API_KEY = "AIzaSyDm7ttpgbeUMpq8diqcLK4uAxlHmMO91fM";
        let chatHistory = [];

        // Toggle settings sidebar
        function toggleSettings() {
            const sidebar = document.getElementById('settings-sidebar');
            sidebar.classList.toggle('hidden');
        }

        // Toggle API key visibility
        function toggleApiKeyVisibility() {
            const input = document.getElementById('custom-api-key');
            const icon = document.getElementById('api-eye-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.setAttribute('data-lucide', 'eye-off');
            } else {
                input.type = 'password';
                icon.setAttribute('data-lucide', 'eye');
            }
            lucide.createIcons();
        }

        // Auto-resize textarea
        const textarea = document.getElementById('chat-input');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 128) + 'px';
        });

        // Send on Enter (but allow Shift+Enter for newline)
        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Add message to chat
        function addMessage(sender, content, isHtml = false) {
            const messagesDiv = document.getElementById('chat-messages');
            const isUser = sender === 'user';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex gap-3 items-start message-enter';
            
            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="flex-1 flex justify-end">
                        <div class="glass-card bg-purple-500/20 p-4 rounded-2xl rounded-tr-sm border-purple-500/30 max-w-3xl">
                            <p class="text-sm text-white">${content}</p>
                        </div>
                    </div>
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-slate-700 to-slate-600 flex items-center justify-center shrink-0">
                        <i data-lucide="user" class="w-5 h-5 text-white"></i>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center shrink-0 shadow-lg shadow-purple-500/30">
                        <i data-lucide="sparkles" class="w-5 h-5 text-white"></i>
                    </div>
                    <div class="flex-1 glass-card p-4 rounded-2xl rounded-tl-sm border-purple-500/20 max-w-4xl">
                        ${isHtml ? content : `<div class="prose prose-invert prose-sm max-w-none text-slate-300">${content}</div>`}
                    </div>
                `;
            }
            
            messagesDiv.appendChild(messageDiv);
            lucide.createIcons();
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Show typing indicator
        function showTyping() {
            const messagesDiv = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'flex gap-3 items-start message-enter';
            typingDiv.innerHTML = `
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center shrink-0 shadow-lg shadow-purple-500/30">
                    <i data-lucide="sparkles" class="w-5 h-5 text-white"></i>
                </div>
                <div class="glass-card p-4 rounded-2xl rounded-tl-sm border-purple-500/20">
                    <div class="flex gap-1.5">
                        <div class="w-2 h-2 bg-purple-400 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-purple-400 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-purple-400 rounded-full typing-dot"></div>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(typingDiv);
            lucide.createIcons();
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        // Send message
        async function sendMessage() {
            const input = textarea.value.trim();
            if (!input) return;

            addMessage('user', input);
            textarea.value = '';
            textarea.style.height = 'auto';

            chatHistory.push({ role: 'user', content: input });

            showTyping();
            await processWithGemini(input);
            hideTyping();
        }

        // Process with Gemini AI
        async function processWithGemini(userMessage) {
            const customKey = document.getElementById('custom-api-key').value.trim();
            const apiKey = customKey || DEFAULT_API_KEY;
            const selectedModel = document.getElementById('gemini-model').value;

            console.log('Using model:', selectedModel);
            console.log('Using custom key:', customKey ? 'Yes' : 'No');

            // Build context-aware prompt
            const conversationContext = chatHistory.slice(-6).map(msg => `${msg.role}: ${msg.content}`).join('\n');
            
            const systemPrompt = `You are an advanced research assistant specialized in space, climate, geography, and scientific topics. Provide detailed, well-formatted responses using markdown. Include relevant facts, statistics, and insights. Be conversational but professional.

Current conversation:
${conversationContext}

User's latest question: ${userMessage}`;

            try {
                if (!window.GoogleGenerativeAI) {
                    throw new Error('Gemini SDK not loaded. Please refresh the page.');
                }

                const genAI = new window.GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: selectedModel });

                const result = await model.generateContent(systemPrompt);
                const response = await result.response;
                const text = response.text();

                chatHistory.push({ role: 'assistant', content: text });

                // Render as markdown
                addMessage('assistant', marked.parse(text));

            } catch (error) {
                console.error('Gemini Error:', error);
                hideTyping();
                addMessage('assistant', `‚ö†Ô∏è Error: ${error.message || 'Unable to process request'}. Please check your API key and try again.`);
            }
        }



        // Search NASA images (manual button click)
        async function searchImages() {
            const query = textarea.value.trim();
            if (!query) {
                addMessage('assistant', '‚ö†Ô∏è Please enter a search term for NASA images (e.g., "Mars", "nebula", "galaxy")');
                return;
            }
            
            textarea.value = '';
            textarea.style.height = 'auto';
            addMessage('user', `üñºÔ∏è Search NASA images: "${query}"`);
            showTyping();
            
            const images = await fetchNASAImages(query);
            hideTyping();
            
            if (images.length > 0) {
                displayImageGrid(query, images);
            } else {
                addMessage('assistant', `No NASA images found for "${query}". Try a different search term.`);
            }
        }

        // Fetch from NASA Images API
        async function fetchNASAImages(query) {
            try {
                const response = await fetch(`https://images-api.nasa.gov/search?q=${encodeURIComponent(query)}&media_type=image`);
                const data = await response.json();
                
                return data.collection.items.slice(0, 12).map(item => ({
                    url: item.links?.[0]?.href,
                    title: item.data[0].title,
                    description: item.data[0].description?.substring(0, 200) || 'NASA Image',
                    source: 'NASA'
                })).filter(img => img.url);
            } catch (e) {
                console.error('NASA API Error:', e);
                return [];
            }
        }

        // Display image grid
        function displayImageGrid(query, images) {
            let imagesHtml = `
                <div class="mb-3">
                    <p class="text-sm text-slate-300">üîç NASA image results for <strong class="text-purple-400">"${query}"</strong> (${images.length} found)</p>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
            `;

            images.forEach(img => {
                if (img.url) {
                    const title = img.title || 'Untitled';
                    const description = img.description || 'No description';
                    
                    imagesHtml += `
                        <div class="group relative rounded-xl overflow-hidden border border-slate-700 hover:border-purple-500/50 transition-all cursor-pointer" onclick='openImageModal(\`${img.url}\`, \`${title.replace(/`/g, '\\`').replace(/"/g, '&quot;')}\`, \`${description.replace(/`/g, '\\`').replace(/"/g, '&quot;')}\`)'>
                            <img src="${img.url}" class="w-full h-40 object-cover group-hover:scale-110 transition-transform duration-300" alt="${title}" loading="lazy" onerror="this.parentElement.style.display='none'">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex items-end p-3">
                                <div class="w-full">
                                    <p class="text-xs text-white font-semibold line-clamp-2 mb-1">${title}</p>
                                    <p class="text-[9px] text-purple-300">NASA</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            imagesHtml += '</div>';
            addMessage('assistant', imagesHtml, true);
        }

        // Open image modal
        function openImageModal(imgUrl, title, description) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/90 backdrop-blur-xl z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="max-w-4xl w-full bg-slate-900 border border-slate-700 rounded-2xl overflow-hidden shadow-2xl">
                    <div class="relative bg-black">
                        <img src="${imgUrl}" class="w-full max-h-[70vh] object-contain" alt="${title}">
                        <button onclick="this.closest('.fixed').remove()" class="absolute top-4 right-4 p-2 bg-black/50 hover:bg-white/10 rounded-full transition-colors">
                            <i data-lucide="x" class="w-5 h-5 text-white"></i>
                        </button>
                    </div>
                    <div class="p-6 bg-slate-900">
                        <h3 class="text-lg font-bold text-white mb-2">${title}</h3>
                        <p class="text-sm text-slate-400 leading-relaxed mb-3">${description}...</p>
                        <div class="mt-4 pt-4 border-t border-slate-700 flex justify-between items-center">
                            <span class="text-xs text-slate-500">Source: NASA</span>
                            <a href="${imgUrl}" target="_blank" class="text-xs text-purple-400 hover:text-purple-300 flex items-center gap-1">
                                <span>Open Original</span>
                                <i data-lucide="external-link" class="w-3 h-3"></i>
                            </a>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            lucide.createIcons();
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

    </script>
</body>

</html>
